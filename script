let isBlown = false;

window.onload = async function() {
  const flame = document.querySelector('.flame');
  const message = document.getElementById('message');
  const candle = document.querySelector('.candle');

  // Pasta oluÅŸumu bitince ("candle" Ã§Ä±ktÄ±ÄŸÄ±nda) mesajÄ± gÃ¶ster
  setTimeout(() => {
    message.textContent = "Mumu Ã¼fle ðŸ’¨";
    message.addEventListener("click", blowOutCandle);
    listenForBlow();
  }, 4000);

  async function listenForBlow() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const audioContext = new AudioContext();
      const analyser = audioContext.createAnalyser();
      const source = audioContext.createMediaStreamSource(stream);
      source.connect(analyser);

      const data = new Uint8Array(analyser.frequencyBinCount);

      function detectBlow() {
        analyser.getByteFrequencyData(data);
        const average = data.reduce((a, b) => a + b) / data.length;

        if (average > 60 && !isBlown) {
          blowOutCandle();
        } else {
          requestAnimationFrame(detectBlow);
        }
      }
      detectBlow();
    } catch (err) {
      console.error("Mikrofon izni vermelisin:", err);
      message.textContent = "Mikrofon izni vermelisin.";
    }
  }

  function blowOutCandle() {
    if (!isBlown) {
      isBlown = true;

      flame.style.display = 'none';
      if (candle) {
        candle.classList.add('falling');
      }

      message.textContent = "DoÄŸum GÃ¼nÃ¼n Kutlu Olsun! ðŸŽ‰ðŸŽ‚";
    }
  }
};
window.onload = function() {
  const candle = document.getElementById('candle');
  const message = document.getElementById('message');
  const birthdayMessage = document.getElementById('birthdayMessage');

  // BaÅŸlangÄ±Ã§ta sadece mum ve doÄŸum gÃ¼nÃ¼ mesajÄ± gizli olsun
  candle.style.display = 'none';
  birthdayMessage.style.display = 'none';

  // Animasyonun bittiÄŸini dinle
  const cremaAnim = document.getElementById('crema');
  cremaAnim.addEventListener('endEvent', () => {
    // Mum gÃ¶rÃ¼nÃ¼r olsun
    candle.style.display = 'block';

    // MesajÄ± deÄŸiÅŸtir
    message.textContent = "Muma Ã¼fle";

    // 3 saniye sonra "DoÄŸum GÃ¼nÃ¼n Kutlu Olsun!" mesajÄ± Ã§Ä±ksÄ±n
    setTimeout(() => {
      message.style.display = 'none';
      birthdayMessage.style.display = 'block';
    }, 3000);
  });
};
